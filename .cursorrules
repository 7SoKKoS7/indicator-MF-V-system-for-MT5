# MasterForex-V Modular (MFV_Modular): Cursor Rules

## Цель
Генерировать и поддерживать модульный индикатор MQL5 «MFV_Modular» по методике MasterForex-V (Master Complex).
Легаси-файл «MasterForex_V_legacy.mq5» используется ТОЛЬКО как эталон, не изменять.

## Scope
Работать только с:
- MQL5/Indicators/MFV_Modular/**
- docs/**
Читать, но НЕ изменять:
- MQL5/Indicators/MasterForex_V_legacy.mq5

## Архитектура (обязательна)
Файлы:
- MQL5/Indicators/MFV_Modular/MFV_Modular.mq5
- MQL5/Indicators/MFV_Modular/include/Config.mqh
- MQL5/Indicators/MFV_Modular/include/State.mqh
- MQL5/Indicators/MFV_Modular/include/MarketData.mqh
- MQL5/Indicators/MFV_Modular/include/PivotEngine.mqh
- MQL5/Indicators/MFV_Modular/include/TrendEngine.mqh
- MQL5/Indicators/MFV_Modular/include/Breakout.mqh
- MQL5/Indicators/MFV_Modular/include/Filters.mqh
- MQL5/Indicators/MFV_Modular/include/Signals.mqh
- MQL5/Indicators/MFV_Modular/include/Draw.mqh
- MQL5/Indicators/MFV_Modular/include/Panel.mqh

Контракты:
- MarketData: Refresh(); ATR/EMA/RSI(tf,period,shift)
- PivotEngine: Get(tf)->{High,Low,lastSwing,ts}
- TrendEngine: Get(tf)->{dir,strength}
- Breakout: H1Confirmed(); RetestOK()
- Filters: Get()->{downgrade:int, block:bool, reasons:string}
- Signals: DecideAndUpdate()->{klass,price,time,note}
- Draw/Panel: только отображение

## Жёсткие правила
1) Решения только по закрытым барам (shift=1). Ноль репейнта.
2) Разделение: расчёты ≠ сигналы ≠ фильтры ≠ отрисовка.
3) Без глобальных статиков с побочками.
4) Не плодить графические объекты, стабильный нейминг MFV_* и реюз.
5) Copy*/iCustom — с проверкой возвратов и ограниченным окном истории.
6) В OnCalculate: Refresh → UpdateAllTF → Update → Decide → Draw → Panel.
7) Выводить полный компилируемый код файлов, без сокращений и псевдокода.

## Подтверждение/ретест
- Подтверждение пробоя: N закрытий H1 над/под dual-pivot(H1).
- Ретест: касание pivot на M15/M5 в окне W баров с допуском по ATR(k1,k2), затем возврат закрытием.
- Классы сигналов: Early/Normal/Strong; Exit/Reverse.
- Фильтры: Volume, Session, Clinch, MarketPhase, Consensus.

## Golden Master
CSV: time,tf,price,pivotH,pivotL,trend,sig,note. Совпадение ≥95% в тестовом окне.

## Производительность
EventSetTimer(1) для панели; тяжёлое в OnCalculate на закрытых барах.

